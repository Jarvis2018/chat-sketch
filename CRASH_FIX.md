# Sketch 崩溃问题修复说明

## 问题描述

在转换复杂 HTML 设计时，Sketch 会出现崩溃闪退的情况。即使是中等复杂度的设计（40-60 个图层）也会导致崩溃。

## 最终解决方案：超级安全模式

**状态**: ✅ 已解决 - 测试确认不再崩溃

经过多次尝试，最终发现问题的根本原因是 **Sketch API 的样式设置方法在处理 html2sketch 生成的复杂数据时非常不稳定**。即使是简单的设计，使用完整的样式 API 也会导致崩溃。

### 解决方案

创建了 **超级安全模式** (`safe-mode-api.js`)，完全避免所有可能导致崩溃的 API：

**只使用最基础的 API**:
- ✅ `new sketch.Group()` - 创建分组
- ✅ `new sketch.Text()` - 创建文本（只设置 fontSize）
- ✅ `new sketch.Shape()` - 创建矩形（只设置基本填充色）

**完全禁用的功能**:
- ❌ Artboard（改用 Group）
- ❌ 圆角 (cornerRadius)
- ❌ 阴影 (shadows)
- ❌ 边框 (borders)
- ❌ 渐变 (gradients)
- ❌ SVG 导入
- ❌ 复杂路径 (shapePath)
- ❌ 复杂样式设置

**安全保护**:
- 每个图层创建都有 try-catch
- 失败的图层会被跳过，不影响其他图层
- 最多处理 50 个图层
- 最大嵌套深度 10 层
- 坐标和尺寸验证

### 测试结果

✅ **简单设计**: 不崩溃  
✅ **中等复杂设计**: 不崩溃  
✅ **多次转换**: 不崩溃  

### 权衡

**优点**:
- 🎯 完全稳定，不会崩溃
- 🚀 转换速度快
- 🔄 可以多次转换

**缺点**:
- 📦 生成的图层非常简单
- 🎨 没有圆角、阴影等样式
- 🖼️ SVG 图标变成灰色矩形
- 🌈 渐变变成纯色

### 使用建议

1. **用插件快速生成基础结构**
2. **在 Sketch 中手动添加样式**
   - 圆角
   - 阴影
   - 渐变
   - 图标

这样既能利用 AI 快速生成布局，又能避免崩溃问题。

## 解决方案演进

### 尝试 1: 使用 Group 替代 Artboard ❌
**结果**: 仍然崩溃  
**原因**: 不是容器类型的问题

### 尝试 2: 降低复杂度限制 ❌
**结果**: 即使 30-60 个图层也崩溃  
**原因**: 不是图层数量的问题

### 尝试 3: 禁用特定 API (渐变、SVG、阴影) ❌
**结果**: 仍然崩溃  
**原因**: 不是单个 API 的问题

### 尝试 4: 超级安全模式 ✅
**结果**: 完全稳定，不再崩溃  
**原因**: 避免了所有复杂的样式 API

**关键发现**: 问题不在于某个特定的 API，而是 **Sketch 的样式系统在处理 html2sketch 生成的复杂样式数据时整体不稳定**。只有使用最基础的 API 才能保证稳定性。

## 其他已实施的修复

## 实现细节

### 新文件: `safe-mode-api.js`

创建了全新的转换引擎，完全独立于原有的 `design-api.js`：

```javascript
// 只创建最基础的图层
export function convertToSketchSafeMode(sketchJSON, page) {
  // 1. 创建根 Group（不是 Artboard）
  const rootGroup = new sketch.Group({ ... })
  
  // 2. 只处理三种图层类型
  switch (layerClass) {
    case 'text':
      // 只设置 text 和 fontSize
      new sketch.Text({ text, frame, fontSize })
      break
      
    case 'rectangle':
    case 'shapePath':
    case 'shapeGroup':
      // 所有形状都变成简单矩形，只设置填充色
      new sketch.Shape({ frame, fills: [{ color }] })
      break
      
    case 'group':
      // 基本分组，最多嵌套 10 层
      new sketch.Group({ frame })
      break
  }
}
```

### 修改: `handler.js`

添加了安全模式开关：

```javascript
const USE_SAFE_MODE = true  // 设置为 true 启用安全模式

function handleConvertToSketch(params, context) {
  if (USE_SAFE_MODE) {
    // 使用超级安全模式
    convertToSketchSafeMode(sketchJSON, page)
  } else {
    // 使用普通模式（可能崩溃）
    createDesignFromSketchJSON(sketchJSON, context)
  }
}
```

## 测试方法

1. 构建插件: `npm run build`
2. 在 Sketch 中重新加载插件
3. 生成任意复杂度的 HTML 设计
4. 点击"转换为 Sketch"
5. 查看消息: "✅ 设计已创建（安全模式）"
6. 验证：
   - ✅ 不会崩溃
   - ✅ 创建了基础图层结构
   - ✅ 文本内容正确
   - ✅ 布局位置正确
   - ⚠️ 没有圆角、阴影等样式（需要手动添加）

### 切换到普通模式（不推荐）

如果想尝试完整样式（可能崩溃），修改 `src/handler.js`:

```javascript
const USE_SAFE_MODE = false  // 改为 false
```

然后重新构建。**警告**: 普通模式可能会崩溃。

## 已知限制

### 安全模式的限制

1. **简化的样式** - 为了稳定性牺牲了样式
   - ❌ 没有圆角
   - ❌ 没有阴影
   - ❌ 没有边框
   - ❌ 没有渐变（变成纯色）
   - ❌ SVG 图标变成灰色矩形
   - ✅ 有基本填充色
   - ✅ 有文本内容和字号
   - ✅ 有正确的布局和位置

2. **图层限制**
   - 最多处理 50 个图层
   - 最大嵌套深度 10 层
   - 失败的图层会被跳过

3. **容器类型**
   - 根容器是 Group，不是 Artboard
   - 不会出现在 Artboard 列表中
   - 可以在 Sketch 中手动转换为 Artboard

## 使用建议

## 使用建议

### 推荐工作流程

1. **用插件生成基础结构**
   - 描述你的设计需求
   - 预览 HTML
   - 转换为 Sketch（安全模式）
   - 得到基础的布局和文本

2. **在 Sketch 中完善样式**
   - 添加圆角（选中图层 → 设置 Radius）
   - 添加阴影（选中图层 → Shadows）
   - 替换图标（删除灰色矩形 → 插入真实图标）
   - 调整颜色和渐变
   - 添加边框

3. **优势**
   - ✅ 快速生成布局结构
   - ✅ 完全稳定，不会崩溃
   - ✅ 可以多次迭代
   - ✅ 保留了手动设计的灵活性

### 对于用户

1. **保持简单** - 描述清晰的布局需求
   - "创建一个登录页面，包含标题、两个输入框、一个按钮"
   - "创建一个产品卡片，包含图片、标题、价格、按钮"

2. **接受简化** - 理解生成的是基础结构
   - 不要期望完美的样式
   - 把它当作快速原型工具
   - 细节在 Sketch 中完善

3. **分批转换** - 复杂设计拆分成多个部分
   - 导航栏单独转换
   - 主内容单独转换
   - 在 Sketch 中组合

### 对于开发者

1. **监控日志** - 查看 Sketch 插件控制台的警告信息
2. **调整阈值** - 根据实际情况调整参数
3. **测试边界** - 使用复杂 HTML 测试崩溃边界

## 未来改进

### 可能的优化方向

1. **渐进式样式应用** - 尝试逐步添加样式
   - 先创建基础图层
   - 然后尝试添加圆角
   - 如果成功，继续添加阴影
   - 失败则回退到安全版本

2. **样式兼容性检测** - 检测哪些样式 API 可用
   - 测试 Sketch 版本
   - 测试各个 API 的稳定性
   - 动态启用/禁用功能

3. **批量样式应用** - 转换后批量设置样式
   - 先创建所有图层（无样式）
   - 等待 Sketch 处理完成
   - 再批量应用样式

4. **用户可配置** - 让用户选择样式级别
   - 极简模式（当前）
   - 基础样式模式（圆角 + 阴影）
   - 完整样式模式（所有样式，可能崩溃）

### 当前不推荐

- ❌ 提高图层限制 - 不是数量问题
- ❌ 重新启用复杂 API - 会导致崩溃
- ❌ 使用 Artboard - Group 已经足够

## 相关文件

- `chat-sketch/src/safe-mode-api.js` - **新增**: 超级安全模式转换引擎
- `chat-sketch/src/handler.js` - **修改**: 添加安全模式开关
- `chat-sketch/src/design-api.js` - 原有转换引擎（已弃用，保留用于参考）
- `chat-sketch/web-panel/src/components/HTMLPreviewModal.vue` - 前端复杂度检测

## 更新日志

- 2026-02-02: 初始尝试 - 使用 Group 替代 Artboard
  - 移除延迟父级附加逻辑
  - 添加背景矩形支持
  - 降低资源限制阈值
  - 增强 SVG 处理安全性
  - 添加前端预警机制
  
- 2026-02-02 (中期): 坐标验证修复
  - 添加坐标范围验证（-100000 到 100000）
  - 跳过超出父容器边界的文本图层（>1000px）
  - 添加 100ms 延迟让 Sketch 处理图层
  - 发现 html2sketch 可能生成越界坐标

- 2026-02-02 (后期): 严格前端限制
  - 降低 MAX_ELEMENT_COUNT 到 30
  - 降低 MAX_ESTIMATED_LAYERS 到 50
  - 降低 MAX_DEPTH 到 15
  - 添加阻止性错误和警告阈值
  - **结果**: 仍然崩溃

- 2026-02-02 (最终): **✅ 超级安全模式 - 问题已解决**
  - 创建全新的 `safe-mode-api.js`
  - 只使用最基础的 Sketch API
  - 完全禁用所有复杂样式
  - 每个图层都有错误容错
  - **测试结果**: 简单和复杂设计都不再崩溃
  - **权衡**: 生成的图层很简单，需要在 Sketch 中手动添加样式

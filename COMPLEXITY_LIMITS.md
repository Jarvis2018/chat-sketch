# 设计复杂度限制说明

## 为什么有这些限制？

经过大量测试发现，Sketch 插件在处理复杂 HTML 转换时容易崩溃。即使是中等复杂度的设计（30-60 个图层）也会导致 Sketch 闪退，特别是在第二次转换时。

为了确保稳定性，我们设置了严格的复杂度限制。

## 硬性限制（超过将无法转换）

| 限制项 | 最大值 | 说明 |
|--------|--------|------|
| DOM 元素数量 | 30 个 | HTML 中的所有标签（div, span, button 等） |
| 预计图层数 | 50 个 | 转换后在 Sketch 中生成的图层数 |
| 嵌套深度 | 15 层 | HTML 标签的最大嵌套层级 |
| SVG 总大小 | 512KB | 所有 SVG 图标的总大小 |

超过这些限制时，转换会被阻止，并显示详细的错误信息和简化建议。

## 警告阈值（会提示但允许继续）

| 限制项 | 警告值 | 说明 |
|--------|--------|------|
| 预计图层数 | 35 个 | 达到 70% 限制时提示 |
| 嵌套深度 | 10 层 | 达到 70% 限制时提示 |

达到警告阈值时，会显示警告对话框，但你可以选择继续转换。

## 如何简化设计

### 1. 减少元素数量

**不好的做法**:
```html
<div class="card">
  <div class="header">
    <div class="icon-wrapper">
      <svg>...</svg>
    </div>
    <div class="title-wrapper">
      <h2>标题</h2>
    </div>
  </div>
  <div class="content">
    <div class="text-wrapper">
      <p>内容</p>
    </div>
  </div>
</div>
```
元素数: 9 个

**好的做法**:
```html
<div class="card">
  <svg>...</svg>
  <h2>标题</h2>
  <p>内容</p>
</div>
```
元素数: 4 个

### 2. 减少嵌套深度

**不好的做法**:
```html
<div>
  <div>
    <div>
      <div>
        <div>
          <button>按钮</button>
        </div>
      </div>
    </div>
  </div>
</div>
```
嵌套深度: 6 层

**好的做法**:
```html
<div>
  <button>按钮</button>
</div>
```
嵌套深度: 2 层

### 3. 简化或移除 SVG

**选项 1**: 使用更简单的 SVG
- 减少路径点数
- 移除不必要的细节
- 使用在线工具优化 SVG（如 SVGOMG）

**选项 2**: 用纯色形状替代
```html
<!-- 不用 SVG -->
<svg width="24" height="24">
  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
  <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
</svg>

<!-- 用简单的矩形 -->
<div style="width: 24px; height: 24px; background: #333; border-radius: 4px;"></div>
```

### 4. 拆分复杂设计

将一个复杂页面拆分成多个小部分：

**原始设计**（太复杂）:
- 导航栏（10 个元素）
- 主内容区（30 个元素）
- 侧边栏（15 个元素）
- 底部（10 个元素）
- **总计: 65 个元素 ❌ 超过限制**

**拆分后**:
1. 导航栏（10 个元素）✅
2. 主内容区（30 个元素）✅
3. 侧边栏（15 个元素）✅
4. 底部（10 个元素）✅

每部分单独转换，然后在 Sketch 中组合。

## 提示词优化建议

### 不好的提示词（会生成复杂设计）

```
创建一个完整的电商产品页面，包含：
- 顶部导航栏，带搜索框、购物车图标、用户头像
- 产品图片轮播（5张图）
- 产品详情（标题、价格、评分、描述）
- 规格选择器（颜色、尺寸）
- 购买按钮和收藏按钮
- 相关推荐（4个产品卡片）
- 用户评论列表（3条评论）
- 底部导航栏
```
预计元素数: 80+ 个 ❌

### 好的提示词（生成简单设计）

```
创建一个简单的产品卡片，包含：
- 产品图片（用灰色占位符）
- 产品标题
- 价格
- 购买按钮
```
预计元素数: 4 个 ✅

或者分步骤：

**步骤 1**: 创建导航栏
```
创建一个简单的导航栏，包含：
- 返回按钮（用 < 符号）
- 标题文字
- 购物车图标（用简单的方形）
```

**步骤 2**: 创建产品信息
```
创建产品信息区域，包含：
- 产品标题
- 价格
- 简短描述
```

**步骤 3**: 创建操作按钮
```
创建两个按钮：
- 加入购物车（蓝色）
- 立即购买（橙色）
```

## 检查设计复杂度

在转换前，插件会自动检测设计复杂度并显示：
- ✅ 绿色：安全，可以转换
- ⚠️ 黄色：接近限制，建议简化
- ❌ 红色：超过限制，必须简化

错误信息会显示：
- 当前值 vs 限制值
- 具体超过了哪些限制
- 详细的简化建议

## 常见问题

### Q: 为什么限制这么严格？
A: 基于实际测试，即使 30-60 个图层也会导致 Sketch 崩溃，特别是第二次转换时。这些限制确保了稳定性。

### Q: 我的设计很简单但还是超过限制？
A: 检查是否有：
- 不必要的包装 div
- 复杂的 SVG 图标
- 过深的嵌套结构

### Q: 可以提高限制吗？
A: 不建议。这些限制是基于大量崩溃测试得出的安全值。提高限制会增加崩溃风险。

### Q: 转换后可以在 Sketch 中添加更多元素吗？
A: 可以！限制只针对 HTML 转换过程。转换后在 Sketch 中手动添加元素是安全的。

## 最佳实践

1. **从简单开始** - 先创建基本结构，转换成功后再在 Sketch 中完善
2. **分批转换** - 将复杂设计拆分成多个小部分
3. **避免装饰** - 转换时去掉装饰性元素，在 Sketch 中添加
4. **使用占位符** - 用简单的矩形代替复杂的图标和图片
5. **测试边界** - 从最简单的设计开始，逐步增加复杂度

## 技术细节

### 前端检测（HTMLPreviewModal.vue）
- 在转换前分析 DOM 结构
- 计算元素数量、嵌套深度、SVG 大小
- 阻止超过限制的转换

### 后端保护（design-api.js）
- MAX_LAYERS: 500（降级保护）
- MAX_DEPTH: 30（降级保护）
- 如果前端检测失败，后端会跳过超出的图层

### 为什么需要两层保护？
- 前端：用户友好的错误提示和建议
- 后端：防止前端检测被绕过或失效

## 相关文档

- [CRASH_FIX.md](./CRASH_FIX.md) - 崩溃问题修复详情
- [QUICK_REFERENCE.md](./QUICK_REFERENCE.md) - 快速参考指南
- [TESTING_GUIDE.md](./TESTING_GUIDE.md) - 测试指南
